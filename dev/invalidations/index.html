<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Invalidations · PrecompileTools.jl</title><meta name="title" content="Invalidations · PrecompileTools.jl"/><meta property="og:title" content="Invalidations · PrecompileTools.jl"/><meta property="twitter:title" content="Invalidations · PrecompileTools.jl"/><meta name="description" content="Documentation for PrecompileTools.jl."/><meta property="og:description" content="Documentation for PrecompileTools.jl."/><meta property="twitter:description" content="Documentation for PrecompileTools.jl."/><meta property="og:url" content="https://JuliaLang.github.io/PrecompileTools.jl/invalidations/"/><meta property="twitter:url" content="https://JuliaLang.github.io/PrecompileTools.jl/invalidations/"/><link rel="canonical" href="https://JuliaLang.github.io/PrecompileTools.jl/invalidations/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">PrecompileTools.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Invalidations</a></li><li><a class="tocitem" href="../explanations/">How PrecompileTools works</a></li><li><a class="tocitem" href="../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Invalidations</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Invalidations</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaLang/PrecompileTools.jl/" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaLang/PrecompileTools.jl/blob/main/docs/src/invalidations.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Why-does-Julia-invalidate-code?"><a class="docs-heading-anchor" href="#Why-does-Julia-invalidate-code?">Why does Julia invalidate code?</a><a id="Why-does-Julia-invalidate-code?-1"></a><a class="docs-heading-anchor-permalink" href="#Why-does-Julia-invalidate-code?" title="Permalink"></a></h1><p>Julia may be unique among computer languages in supporting all four of the following features:</p><ol><li>interactive development</li><li>&quot;method overloading&quot; by packages that don&#39;t own the function</li><li>aggressive compilation</li><li>consistent compilation: same result no matter how you got there</li></ol><p>The combination of these features <em>requires</em> that you sometimes &quot;throw away&quot; code that you have previously compiled.</p><p>To illustrate: suppose you have a function <code>numchildren</code> with one method,</p><pre><code class="nohighlight hljs">numchildren(::Any) = 1</code></pre><p>and then write</p><pre><code class="nohighlight hljs">total_children(list) = sum(numchildren.(list))</code></pre><p>Now let <code>list</code> be a <code>Vector{Any}</code>. You can compile a fast <code>total_children(::Vector{Any})</code> (<em>aggressive compilation</em>) by leveraging the fact that you know there&#39;s only one possible method of <code>numchildren</code>, and you know that it returns 1 for every input. Thus, <code>total_children(list)</code> gives you just <code>length(list)</code>, which would indeed be a very highly-optimized implementation!</p><p>But now suppose you add a second method (<em>interactive development</em> + <em>method overloading</em>)</p><pre><code class="nohighlight hljs">numchildren(::BinaryNode) = 2</code></pre><p>where <code>BinaryNode</code> is a new type you&#39;ve defined (so it&#39;s not type-piracy). If you want to get the right answer (<em>consistent compilation</em>) from an arbitrary <code>list::Vector{Any}</code>, there are only two options:</p><blockquote><p><strong>Option A</strong>: plan for this eventuality from the beginning, by making every <code>numchildren(::Any)</code> be called by runtime dispatch. But when there is only one method of <code>numchildren</code>, forcing runtime dispatch makes the code vastly slower. Thus, this option at least partly violates <em>aggressive compilation</em>.</p></blockquote><blockquote><p><strong>Option B</strong>: throw away the code for <code>total_children</code> that you created when there was only one method of <code>numchildren</code>, and recompile it in this new world where there are two.</p></blockquote><p>Julia does a mix of these: it does <strong>B</strong> up to 3 methods, and then <strong>A</strong> thereafter. (Recent versions of Julia have experimental support for customizing this behavior with <code>Base.Experimental.@max_methods</code>.)</p><p>This example was framed as an experiment at the REPL, but it is also relevant if you load two packages: <code>PkgX</code> might define <code>numchildren</code> and <code>total_children</code>, and <code>PkgY</code> might load <code>PkgX</code> and define a second method of <code>PkgX.numchildren</code>. Any precompilation that occurs in <code>PkgX</code> doesn&#39;t know what&#39;s going to happen in <code>PkgY</code>. Therefore, unless you want to defer <em>all</em> compilation, including for Julia itself, until the entire session is loaded and then closed to further extension (similar to how compilers for C, Rust, etc. work), you have to make the same choice between options <strong>A</strong> and <strong>B</strong>.</p><p>Given that invalidation is necessary if Julia code is to be both fast and deliver the answers you expect, invalidation is a good thing! But sometimes Julia &quot;defensively&quot; throws out code that might be correct but can&#39;t be proved to be correct by Julia&#39;s type-inference machinery; such cases of &quot;spurious invalidation&quot; serve to (uselessly) increase latency and worsen the Julia experience. Except in cases of <a href="https://docs.julialang.org/en/v1/manual/style-guide/#Avoid-type-piracy">piracy</a>, invalidation is a risk only for poorly-inferred code. With our example of <code>numchildren</code> and <code>total_children</code> above, the invalidations were necessary because <code>list</code> was a <code>Vector{Any}</code>, meaning that the elements might be of <code>Any</code> type and therefore Julia can&#39;t predict in advance which method(s) of <code>numchildren</code> would be applicable. Were one to create <code>list</code> as, say, <code>list = Union{BinaryNode,TrinaryNode}[]</code> (where <code>TrinaryNode</code> is some other kind of object with children), Julia would know much more about the types of the objects to which it applies <code>numchildren</code>: defining yet another new method like <code>numchildren(::ArbitraryNode)</code> would not trigger invalidations of code that was compiled for a <code>list::Vector{Union{BinaryNode,TrinaryNode}}</code>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../explanations/">How PrecompileTools works »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.9.0 on <span class="colophon-date" title="Thursday 3 April 2025 13:44">Thursday 3 April 2025</span>. Using Julia version 1.13.0-DEV.350.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
